@page "/sales"
@layout DashboardLayout

@using PharmacyManagementSystem.Services

<PageTitle>Sales & Billing - PharmERP</PageTitle>

<div class="h-full flex flex-col bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
	<div class="flex-shrink-0 p-6 border-b border-slate-700/50">
		<div class="flex items-center justify-between">
			<div>
				<h1 class="text-3xl font-bold text-white">Sales & Billing (Point of Sale)</h1>
				<p class="mt-1 text-sm text-slate-400">Process sales and generate receipts</p>
			</div>
		</div>
	</div>

	<div class="flex-shrink-0 flex gap-6 p-6 overflow-y-auto max-h-[70vh]">
		<div class="flex-1 flex flex-col bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 overflow-hidden">
			<div class="flex-shrink-0 p-6 border-b border-slate-700/50">
				<h2 class="text-lg font-semibold text-white mb-4">Select Medicine</h2>
				<div class="relative">
					<input type="text"
						   @bind="searchQuery"
						   @bind:event="oninput"
						   placeholder="Search by name"
						   class="w-full pl-12 pr-12 py-3 bg-slate-900/70 border border-slate-600 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
					<svg class="absolute left-4 top-3.5 w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
					</svg>
				</div>
			</div>

			<div class="flex-1 overflow-y-auto">
				@if (isLoading)
				{
					<div class="flex items-center justify-center p-10 text-blue-400">Loading Inventory...</div>
				}
				else if (!medicines.Any())
				{
					<div class="flex-1 flex items-center justify-center p-10">
						<div class="text-center text-slate-500">
							<svg class="w-24 h-24 mx-auto mb-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
							</svg>
							<h3 class="text-xl font-medium mb-2">No medicines available</h3>
							<p class="text-sm">Add medicines in Inventory first</p>
						</div>
					</div>
				}
				else
				{
					<div class="p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
						@foreach (var m in FilteredMedicines)
						{
							<div @onclick="() => AddToCart(m)"
								 class="@(m.Quantity > 0 ? "bg-slate-700/50 hover:bg-slate-700/80 cursor-pointer" : "bg-red-900/30 text-red-400 cursor-not-allowed") p-4 rounded-xl border border-slate-700/50 transition-colors">
								<h4 class="font-medium text-white truncate">@m.Name</h4>
								<p class="text-xs text-slate-400 mt-1">Stock: @m.Quantity</p>
								<p class="text-xl font-bold text-emerald-400 mt-2">$@m.Price:F2</p>
							</div>
						}
					</div>
				}
			</div>
		</div>

		<div class="w-[28rem] flex flex-col bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 overflow-hidden">

			<div class="flex-shrink-0 p-6 border-b border-slate-700/50 flex items-center justify-between">
				<h2 class="text-lg font-semibold text-white">Current Sale</h2>
				<button @onclick="ClearCart"
						class="@(cartItems.Any() ? "text-red-400 hover:text-red-300" : "text-slate-600 cursor-not-allowed")">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							  d="M19 7l-.867 12.142A2.002 2.002 0 0116.138 21H7.862a2.002 2.002 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
					</svg>
				</button>
			</div>

			<div class="flex-1 overflow-y-auto px-4 py-4">
				@if (!cartItems.Any())
				{
					<div class="h-full flex items-center justify-center text-center text-slate-500">
						<div>
							<svg class="w-20 h-20 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									  d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
							</svg>
							<p class="text-lg font-medium">Cart is empty</p>
							<p class="text-sm mt-1">Select medicines to start a sale</p>
						</div>
					</div>
				}
				else
				{
					<div class="space-y-3 mb-6">
						@foreach (var item in cartItems)
						{
							<div class="p-3 bg-slate-900/40 rounded-lg border border-slate-700/50">
								<div class="flex items-center justify-between mb-2">
									<div>
										<h4 class="font-medium text-white">@item.Medicine.Name</h4>
										<p class="text-xs text-slate-400">$@item.Medicine.Price:F2 each</p>
									</div>
									<button @onclick="() => RemoveFromCart(item)"
											class="text-red-400 hover:text-red-300">
										<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
										</svg>
									</button>
								</div>

								<div class="flex items-center justify-between">
									<div class="flex items-center space-x-3">
										<span class="text-xs text-slate-500">Qty</span>
										<div class="flex items-center bg-slate-800/60 rounded-lg">
											<button @onclick="() => DecreaseQty(item)" class="px-2 py-0.5 text-slate-400 hover:text-white">
												<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
												</svg>
											</button>
											<span class="px-3 text-white font-medium text-sm">@item.Quantity</span>
											<button @onclick="() => IncreaseQty(item)" class="px-2 py-0.5 text-slate-400 hover:text-white">
												<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
												</svg>
											</button>
										</div>
									</div>
									<div>
										<label class="text-xs text-slate-500">Disc %</label>
										<input @bind="item.DiscountPercent" @bind:event="oninput"
											   type="number" min="0" max="100"
											   class="w-12 text-center bg-transparent border-b border-slate-600 text-white text-xs focus:outline-none focus:border-blue-500" />
									</div>
								</div>

								<div class="mt-2 text-right">
									<span class="text-base font-bold text-emerald-400">$@item.Total:F2</span>
								</div>
							</div>
						}
					</div>

					<div class="p-4 bg-slate-900/40 rounded-xl border border-slate-700/50 space-y-3">
						<div class="space-y-2">
							<div class="flex justify-between text-sm">
								<span class="text-slate-400">Subtotal:</span>
								<span class="text-white">$@Subtotal:F2</span>
							</div>
							<div class="flex justify-between text-sm">
								<span class="text-slate-400">Discount:</span>
								<span class="text-red-400">-$@TotalDiscount:F2</span>
							</div>
							<div class="flex justify-between pt-3 border-t border-slate-600">
								<span class="text-xl font-bold text-white">Total:</span>
								<span class="text-2xl font-bold text-emerald-400">$@Total:F2</span>
							</div>
						</div>

						<div>
							<label class="block text-xs font-medium text-slate-400 mb-1">Payment Method</label>
							<select @bind="paymentMethod"
									class="w-full px-3 py-2 text-sm bg-slate-800/60 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
								<option value="Cash">Cash</option>
								<option value="Card">Card</option>
							</select>
						</div>

						<div>
							<label class="block text-xs font-medium text-slate-400 mb-1">Amount Paid</label>
							<input @bind="amountPaid" @bind:event="oninput" type="number" step="0.01"
								   placeholder="0.00"
								   class="w-full px-3 py-2 text-sm bg-slate-800/60 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
							@if (amountPaid > Total)
							{
								<p class="mt-2 text-xs text-emerald-400 text-right">Change: $@(amountPaid - Total):F2</p>
							}
						</div>

						<button @onclick="CompleteSale"
								disabled="@(amountPaid < Total)"
								class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-700 disabled:cursor-not-allowed text-white font-bold rounded-xl transition-all text-base shadow-lg shadow-emerald-500/20 flex items-center justify-center space-x-2">
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
							</svg>
							<span>Complete Sale</span>
						</button>
					</div>
				}
			</div>

			@if (!cartItems.Any())
			{
				<div class="flex-shrink-0 px-6 py-4 border-t border-slate-700/50 bg-slate-900/40">
					<div class="text-center text-slate-500 py-8">
						<p>No items in cart</p>
					</div>
				</div>
			}
		</div>
	</div>

	<div class="p-6 flex flex-col flex-1">
		<h2 class="text-xl font-bold text-white mb-4">Recent Sales Transactions</h2>

		<div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 overflow-hidden flex-1 min-h-0">
			<div class="overflow-x-auto h-full">
				@if (!recentSales.Any())
				{
					<div class="p-6 text-center text-slate-500">No recent sales to display.</div>
				}
				else
				{
					<table class="min-w-full divide-y divide-slate-700">
						<thead class="bg-slate-700/50 sticky top-0">
							<tr>
								<th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Sale ID</th>
								<th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Sale Date</th>
								<th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Medicine Name</th>
								<th class="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Unit Price</th>
								<th class="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Qty</th>
								<th class="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Disc %</th>
								<th class="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Line Total</th>
								<th class="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Sale Total</th>
								<th class="px-6 py-3 text-right text-xs font-medium text-slate-300 uppercase tracking-wider">Actions</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-slate-800">
							@foreach (var sale in recentSales)
							{
								var rowSpan = sale.Items.Count;
								var isFirstRow = true;

								@foreach (var item in sale.Items)
								{
									<tr class="hover:bg-slate-700/30 transition-colors">
										@if (isFirstRow)
										{
											<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-400" rowspan="@rowSpan">@sale.SaleId</td>
											<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300" rowspan="@rowSpan">@sale.SaleDate.ToString("MMM dd, hh:mm tt")</td>
										}

										<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">@item.MedicineName</td>
										<td class="px-6 py-4 whitespace-nowrap text-sm text-right text-slate-400">$@item.UnitPrice:F2</td>
										<td class="px-6 py-4 whitespace-nowrap text-sm text-right text-slate-400">@item.Quantity</td>
										<td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-400">@item.DiscountPct%</td>
										<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right text-emerald-400">$@item.TotalAmount:F2</td>

										@if (isFirstRow)
										{
											<td class="px-6 py-4 whitespace-nowrap text-base font-bold text-right text-emerald-400" rowspan="@rowSpan">$@sale.TotalSaleAmount:F2</td>

											<td class="px-6 py-4 whitespace-nowrap text-right" rowspan="@rowSpan">
												<div class="flex items-center justify-end space-x-2">
													<button @onclick="() => EditSale(sale.SaleId)"
															class="text-blue-400 hover:text-blue-300 p-1 rounded hover:bg-slate-700/50 transition-colors">
														<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
															<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-7l4-4m-4 4l4 4m-4-4H9m-1 7h.01M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h7" />
														</svg>
													</button>
													<button @onclick="() => DeleteSale(sale.SaleId)"
															class="text-red-400 hover:text-red-300 p-1 rounded hover:bg-slate-700/50 transition-colors">
														<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
															<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2.002 2.002 0 0116.138 21H7.862a2.002 2.002 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
														</svg>
													</button>
												</div>
											</td>

											isFirstRow = false;
										}
									</tr>
								}
							}
						</tbody>
					</table>
				}
			</div>
		</div>
	</div>
</div>

@code {
	[Inject]
	public IMedicineService? MedicineService { get; set; }
	[Inject]
	public ISaleService? SaleService { get; set; }
	[Inject]
	public IJSRuntime? JS { get; set; }

	private bool isLoading = true;
	private string searchQuery = "";
	private string paymentMethod = "Cash";
	private decimal amountPaid = 0;

	private List<PharmacyManagementSystem.Services.Medicines> medicines = new();
	private List<CartItem> cartItems = new();
	private List<SaleRecord> recentSales = new();

	private List<PharmacyManagementSystem.Services.Medicines> FilteredMedicines =>
	string.IsNullOrWhiteSpace(searchQuery)
	 ? medicines
	 : medicines.Where(m =>
		m.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)
	 ).ToList();

	private decimal Subtotal => cartItems.Sum(i => i.Subtotal);
	private decimal TotalDiscount => cartItems.Sum(i => i.DiscountAmount);
	private decimal Total => cartItems.Sum(i => i.Total);

	protected override async Task OnInitializedAsync()
	{
		await LoadMedicines();
		await LoadRecentSales();
	}

	private async Task LoadMedicines()
	{
		isLoading = true;
		try
		{
			medicines = (await MedicineService!.GetAllMedicinesAsync()) ?? new List<PharmacyManagementSystem.Services.Medicines>();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading medicines: {ex.Message}");
			if (JS is not null) await JS.InvokeVoidAsync("alert", $"Error loading medicines: {ex.Message}");
		}
		finally
		{
			isLoading = false;
			StateHasChanged();
		}
	}

	private async Task LoadRecentSales()
	{
		try
		{
			recentSales = (await SaleService!.GetRecentSalesAsync()) ?? new List<SaleRecord>();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading recent sales from service: {ex.Message}");
		}
		finally
		{
			StateHasChanged();
		}
	}


	private async Task AddToCart(PharmacyManagementSystem.Services.Medicines medicine)
	{
		var existingItem = cartItems.FirstOrDefault(i => i.Medicine.MedicineId == medicine.MedicineId);

		if (existingItem != null)
		{
			await IncreaseQty(existingItem);
		}
		else if (medicine.Quantity > 0)
		{
			cartItems.Add(new CartItem { Medicine = medicine, Quantity = 1 });
			StateHasChanged();
		}
		else
		{
			if (JS is not null) await JS.InvokeVoidAsync("alert", $"{medicine.Name} is out of stock.");
		}
	}

	private void RemoveFromCart(CartItem item)
	{
		cartItems.Remove(item);
		StateHasChanged();
	}

	private async Task IncreaseQty(CartItem item)
	{

		if (item.Quantity < item.Medicine.Quantity)
		{
			item.Quantity++;
			StateHasChanged();
		}
		else
		{
			if (JS is not null) await JS.InvokeVoidAsync("alert", $"Cannot add more {item.Medicine.Name}. Only {item.Medicine.Quantity} in stock.");
		}
	}

	private void DecreaseQty(CartItem item)
	{
		if (item.Quantity > 1) item.Quantity--;
		else RemoveFromCart(item);
		StateHasChanged();
	}

	private void ClearCart()
	{
		cartItems.Clear();
		amountPaid = 0;
		StateHasChanged();
	}

	private async Task CompleteSale()
	{
		if (amountPaid < Total) return;

		try
		{
			await SaleService!.RecordSaleAsync(
		cartItems,
		paymentMethod,
		Total,
		TotalDiscount,
		amountPaid
	 );

			if (JS is not null) await JS.InvokeVoidAsync("alert",
			 $"Sale completed successfully!\nTotal: ${Total:F2}\nPaid: ${amountPaid:F2}\nChange: ${(amountPaid - Total):F2}");

			cartItems.Clear();
			amountPaid = 0;
			await LoadMedicines();
			await LoadRecentSales();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Sale Failed: {ex}");
			if (JS is not null) await JS.InvokeVoidAsync("alert", $"ERROR: Sale transaction failed. Details: {ex.Message}");
		}
	}

	private async Task EditSale(int saleId)
	{
		// TODO: Implement navigation to an EditSale page or open a modal
		if (JS is not null) await JS.InvokeVoidAsync("alert", $"Editing Sale ID: {saleId}. Implementation pending.");
	}

	private async Task DeleteSale(int saleId)
	{
		// TODO: Implement confirmation and actual deletion logic in ISaleService
		var confirm = await JS!.InvokeAsync<bool>("confirm", $"Are you sure you want to delete Sale ID {saleId}?");
		if (confirm)
		{
			// Example: await SaleService!.DeleteSaleAsync(saleId);
			if (JS is not null) await JS.InvokeVoidAsync("alert", $"Sale ID {saleId} deleted successfully! (Placeholder)");
			await LoadRecentSales(); // Refresh the list after deletion
		}
	}

	public class CartItem
	{
		public PharmacyManagementSystem.Services.Medicines Medicine { get; set; } = new();
		public int Quantity { get; set; } = 1;
		public decimal DiscountPercent { get; set; } = 0;
		public decimal Subtotal => Medicine.Price * Quantity;
		public decimal DiscountAmount => Subtotal * (DiscountPercent / 100);
		public decimal Total => Subtotal - DiscountAmount;
	}
}