@page "/reports"
@layout DashboardLayout
@using PharmacyManagementSystem.Services
@using System.Collections.Generic
@using System.Linq
@using System
@using Microsoft.AspNetCore.Components
@using ApexCharts
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure
@inject IJSRuntime JS
@inject ISaleService SaleService

<PageTitle>Reports & Analytics - PharmERP</PageTitle>

<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6 space-y-8">

    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Reports & Analytics</h1>
            <p class="mt-1 text-sm text-slate-400">View and export business reports</p>
        </div>

        <select @onchange="OnPeriodChanged"
                        class="px-6 py-3 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-lg font-medium transition-colors cursor-pointer">
            <option value="Daily">Daily</option>
            <option value="Weekly">Weekly</option>
            <option value="Monthly" selected>Monthly</option>
            <option value="Yearly">Yearly</option>
        </select>
    </div>

    @* ---------- Stats Cards ---------- *@
    @if (isLoading)
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            @for (int i = 0; i < 4; i++)
            {
                <div class="bg-slate-800/50 rounded-xl border border-slate-700/50 p-6 animate-pulse">
                    <div class="h-6 bg-slate-700 rounded w-1/2 mb-4"></div>
                    <div class="h-8 bg-slate-600 rounded w-3/4"></div>
                    <div class="h-4 bg-slate-700 rounded w-1/3 mt-3"></div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 p-6">
                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mb-4">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                             d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <p class="text-sm text-slate-400">Total Revenue</p>
                <h3 class="text-3xl font-bold text-white mt-2">@stats.TotalRevenue.ToString("C2")</h3>
                <p class="text-xs text-slate-500 mt-2">from @stats.TotalTransactions transactions</p>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 p-6">
                <div class="w-12 h-12 bg-emerald-500/20 rounded-lg flex items-center justify-center mb-4">
                    <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                             d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                </div>
                <p class="text-sm text-slate-400">Total Profit</p>
                <h3 class="text-3xl font-bold text-white mt-2">@stats.TotalProfit.ToString("C2")</h3>
                <p class="text-xs text-slate-500 mt-2">Current period's gain</p>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 p-6">
                <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center mb-4">
                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                             d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                </div>
                <p class="text-sm text-slate-400">Items Sold</p>
                <h3 class="text-3xl font-bold text-white mt-2">@stats.ItemsSold</h3>
                <p class="text-xs text-slate-500 mt-2">Total units moved</p>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 p-6">
                <div class="w-12 h-12 bg-amber-500/20 rounded-lg flex items-center justify-center mb-4">
                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                             d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                </div>
                <p class="text-sm text-slate-400">Transactions</p>
                <h3 class="text-3xl font-bold text-white mt-2">@stats.TotalTransactions</h3>
                <p class="text-xs text-slate-500 mt-2">Total sales count</p>
            </div>
        </div>
    }

    <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 overflow-hidden">
        <div class="border-b border-slate-700/50">
            <nav class="flex -mb-px">
                <button @onclick="() => activeTab = 0"
                                    class="@(activeTab == 0 ? "border-blue-500 text-blue-400" : "border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-600") px-8 py-4 text-sm font-medium border-b-2 transition-colors">
                    Sales Reports
                </button>
                <button @onclick="() => activeTab = 1"
                                    class="@(activeTab == 1 ? "border-blue-500 text-blue-400" : "border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-600") px-8 py-4 text-sm font-medium border-b-2 transition-colors">
                    Inventory Reports
                </button>
                <button @onclick="() => activeTab = 2"
                                    class="@(activeTab == 2 ? "border-blue-500 text-blue-400" : "border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-600") px-8 py-4 text-sm font-medium border-b-2 transition-colors">
                    Purchase Reports
                </button>
            </nav>
        </div>

        <div class="p-8 space-y-8">
            @if (activeTab == 0)
            {
                @if (isLoading)
                {
                    <p class="text-center text-slate-400 py-10">Loading sales data...</p>
                }
                else if (salesData?.Any() == true)
                {
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700/50">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-white font-medium">Revenue & Profit Trend</h4>
                                <button @onclick="ExportPdf"
                                                            class="text-slate-400 hover:text-white flex items-center space-x-1 border border-slate-600 rounded px-2.5 py-1.5 text-xs">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                                     d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <span>PDF</span>
                                </button>
                            </div>

                            <ApexChart @ref="revenueChart"
                                                           TItem="ChartPoint"
                                                           Options="revenueOptions"
                                                           Height="320">
                                <ApexPointSeries TItem="ChartPoint"
                                                                         Items="revenuePoints"
                                                                         Name="Revenue"
                                                                         SeriesType="SeriesType.Line"
                                                                         Color="#3B82F6" />
                                <ApexPointSeries TItem="ChartPoint"
                                                                         Items="profitPoints"
                                                                         Name="Profit"
                                                                         SeriesType="SeriesType.Line"
                                                                         Color="#10B981" />
                            </ApexChart>
                        </div>

                        <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700/50">
                            <h4 class="text-white font-medium mb-4">Sales by Category</h4>

                            <ApexChart @ref="categoryChart"
                                                           TItem="CategoryData"
                                                           Options="categoryOptions"
                                                           Height="320">
                                <ApexPointSeries TItem="CategoryData"
                                                                         Items="categoryData"
                                                                         Name="Sales"
                                                                         SeriesType="SeriesType.Pie"
                                                                         XValue="e => e.Category"
                                                                         YValue="e => e.Value" />
                            </ApexChart>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold text-white mt-8 mb-4">Detailed Sales Transactions</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-700">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Customer</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Profit</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700">
                                @foreach (var entry in salesData.OrderByDescending(x => x.SaleDate))
                                {
                                    <tr class="hover:bg-slate-700/30 transition">
                                        <td class="px-4 py-3 text-sm text-slate-300">@entry.SaleDate.ToString("MM/dd/yyyy")</td>
                                        <td class="px-4 py-3 text-sm text-slate-300">@entry.CustomerName</td>
                                        <td class="px-4 py-3 text-sm font-semibold text-white">@entry.TotalAmount.ToString("C2")</td>
                                        <td class="px-4 py-3 text-sm text-emerald-400">@entry.Profit.ToString("C2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-20">
                        <h3 class="text-xl font-semibold text-white mb-2">No Sales Data</h3>
                        <p class="text-slate-400">Sales will appear here once recorded.</p>
                    </div>
                }
            }
            else if (activeTab == 1)
            {
                <div class="text-center py-20 text-slate-400">Inventory Reports coming soon...</div>
            }
            else if (activeTab == 2)
            {
                <div class="text-center py-20 text-slate-400">Purchase Reports coming soon...</div>
            }
        </div>
    </div>
</div>

@code {
    // NOTE: Ensure TopStats, SaleReportEntry, and CategoryData are defined
    // in the DTOs namespace or remove the local classes if they exist elsewhere.
    // For this demonstration, the ChartPoint class is kept local.
    private int activeTab = 0;
    private bool isLoading = true;
    private string selectedPeriod = "Monthly";

    private TopStats stats = new();
    private List<SaleReportEntry> salesData = new();
    private List<CategoryData> categoryData = new();

    private ApexChart<ChartPoint>? revenueChart;
    private ApexChart<CategoryData>? categoryChart;

    private List<ChartPoint> revenuePoints = new();
    private List<ChartPoint> profitPoints = new();

    private ApexChartOptions<ChartPoint> revenueOptions = new();
    private ApexChartOptions<CategoryData> categoryOptions = new();

    private bool _chartsInitialized = false;

    // -----------------------------------------------------------------
    // 1. Load data
    // -----------------------------------------------------------------
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    // -----------------------------------------------------------------
    // 2. Render charts after DOM
    // -----------------------------------------------------------------
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_chartsInitialized)
        {
            _chartsInitialized = true;
            await BuildCharts();
        }
    }

    // -----------------------------------------------------------------
    // 3. Period changed
    // -----------------------------------------------------------------
    private async void OnPeriodChanged(ChangeEventArgs e)
    {
        selectedPeriod = e.Value?.ToString() ?? "Monthly";
        await LoadData();

        if (_chartsInitialized && (revenueChart != null || categoryChart != null))
        {
            await BuildCharts();
        }
    }

    // -----------------------------------------------------------------
    // Load & GROUP data by date label
    // -----------------------------------------------------------------
    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var (startDate, endDate) = GetDateRange(selectedPeriod);

            stats = await SaleService.GetAggregateStatsAsync(selectedPeriod);
            salesData = await SaleService.GetSalesReportsAsync(selectedPeriod);
            categoryData = await SaleService.GetSalesByCategoryAsync(startDate, endDate);

            // GROUP BY DATE LABEL
            var grouped = salesData
        .GroupBy(x => FormatDateLabel(x.SaleDate, selectedPeriod))
        .Select(g => new
        {
            Label = g.Key,
            Revenue = g.Sum(x => x.TotalAmount),
            Profit = g.Sum(x => x.Profit)
        })
        .OrderBy(x => x.Label)
        .ToList();

            revenuePoints = grouped.Select(g => new ChartPoint { X = g.Label, Y = g.Revenue }).ToList();
            profitPoints = grouped.Select(g => new ChartPoint { X = g.Label, Y = g.Profit }).ToList();

            // Fallback
            if (!revenuePoints.Any()) revenuePoints.Add(new ChartPoint { X = "No data", Y = 0 });
            if (!profitPoints.Any()) profitPoints.Add(new ChartPoint { X = "No data", Y = 0 });
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // -----------------------------------------------------------------
    // Build charts + safe render
    // -----------------------------------------------------------------
    private async Task BuildCharts()
    {
        revenueOptions = new()
        {
            Theme = new Theme { Mode = Mode.Dark },
            Chart = new Chart { ForeColor = "#CBD5E0", Background = "transparent" },
            Xaxis = new XAxis { Categories = revenuePoints.Select(p => p.X).ToList() },
            Stroke = new Stroke { Curve = Curve.Smooth },
            Tooltip = new Tooltip { Enabled = true },
            Grid = new Grid { Show = true }
        };

        categoryOptions = new()
        {
            Theme = new Theme { Mode = Mode.Dark },
            Chart = new Chart { ForeColor = "#CBD5E0" },
            Labels = categoryData.Select(c => c.Category).ToList(),
            Legend = new Legend { Position = LegendPosition.Bottom }
        };

        if (revenueChart != null) await revenueChart.RenderAsync();
        if (categoryChart != null) await categoryChart.RenderAsync();
    }

    // -----------------------------------------------------------------
    // PDF Export
    // -----------------------------------------------------------------
    private async Task ExportPdf()
    {
        var document = Document.Create(container =>
        {
            container.Page(page =>
        {
              page.Size(PageSizes.A4);
              page.Margin(2, Unit.Centimetre);
              page.PageColor(Colors.White);
              page.DefaultTextStyle(x => x.FontSize(12));

              page.Header().Text("PharmERP Sales Report").FontSize(20).Bold().FontColor(Colors.Blue.Medium);

              page.Content().PaddingVertical(1, Unit.Centimetre).Column(col =>
          {
                col.Item().Text($"Period: {selectedPeriod}").FontSize(14);
                col.Item().Text($"Generated: {DateTime.Now:yyyy-MM-dd HH:mm}");
                col.Item().PaddingTop(10).Text($"Revenue: {stats.TotalRevenue:C2}");
                col.Item().Text($"Profit: {stats.TotalProfit:C2}");
                col.Item().Text($"Transactions: {stats.TotalTransactions}");
                col.Item().Text($"Items Sold: {stats.ItemsSold}");

                col.Item().PaddingTop(20).Text("Sales by Category").FontSize(16).Bold();
                foreach (var cat in categoryData)
                {
                    col.Item().Text($"• {cat.Category}: {cat.Value:C2}");
                }
            });

              page.Footer().AlignCenter().Text(x =>
          {
                x.Span("Page ");
                x.CurrentPageNumber();
            });
          });
        });

        var bytes = document.GeneratePdf();
        var fileName = $"PharmERP_Report_{selectedPeriod}_{DateTime.Now:yyyyMMdd}.pdf";
        await JS.InvokeVoidAsync("saveAsFile", fileName, Convert.ToBase64String(bytes));
    }

    // -----------------------------------------------------------------
    // Helpers
    // -----------------------------------------------------------------
    private (DateTime start, DateTime end) GetDateRange(string period)
    {
        var now = DateTime.Today;
        return period switch
        {
            "Daily" => (now, now.AddDays(1)),
            "Weekly" => (now.AddDays(-(int)now.DayOfWeek), now.AddDays(7 - (int)now.DayOfWeek)),
            "Monthly" => (new DateTime(now.Year, now.Month, 1), new DateTime(now.Year, now.Month, 1).AddMonths(1)),
            "Yearly" => (new DateTime(now.Year, 1, 1), new DateTime(now.Year + 1, 1, 1)),
            _ => (new DateTime(now.Year, now.Month, 1), new DateTime(now.Year, now.Month, 1).AddMonths(1))
        };
    }

    private string FormatDateLabel(DateTime date, string period) => period switch
    {
        "Daily" => date.ToString("MM/dd"),
        "Weekly" => $"Week {GetWeekNumber(date)}",
        "Monthly" => date.ToString("MMM yyyy"),
        "Yearly" => date.ToString("yyyy"),
        _ => date.ToString("MM/dd")
    };

    private int GetWeekNumber(DateTime date)
    {
        var cal = System.Globalization.DateTimeFormatInfo.CurrentInfo?.Calendar;
        return cal?.GetWeekOfYear(date, System.Globalization.CalendarWeekRule.FirstDay, DayOfWeek.Sunday) ?? 1;
    }

    // Placeholder classes for DTOs if they don't exist in the DTOs namespace yet
    // NOTE: If you defined these elsewhere, you should delete the local definitions below.

    // public class TopStats { ... }
    // public class SaleReportEntry { ... }
    // public class CategoryData { ... }

    public class ChartPoint
    {
        public string X { get; set; } = "";
        public decimal Y { get; set; }
    }
}